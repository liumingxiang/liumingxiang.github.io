<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 设计模式之观察者模式 · Hexo</title><meta name="description" content="设计模式之观察者模式 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Hexo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章列表</a></li><li class="nav-list-item"><a href="https://github.com/xuhongbo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/abstract/" target="_self" class="nav-list-link">个人简介</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">设计模式之观察者模式</h1><div class="post-info">Feb 23, 2015</div><div class="post-content"><p>观察者模式又叫发布订阅模式（Publish/Subscribe），它定义了一种一对多的关系，让多个观察者对象同时监听某一个主题对象，这个主题对象的状态发生变化时就会通知所有的观察者对象，使得它们能够自动更新自己。</p>
<p>使用观察者模式的好处：</p>
<ol>
<li>支持简单的广播通信，自动通知所有已经订阅过的对象。</li>
<li>页面载入后目标对象很容易与观察者存在一种动态关联，增加了灵活性。</li>
<li>目标对象与观察者之间的抽象耦合关系能够单独扩展以及重用。<a id="more"></a>
<h2 id="正文（版本一）"><a href="#正文（版本一）" class="headerlink" title="正文（版本一）"></a>正文（版本一）</h2></li>
</ol>
<p>JS 里对观察者模式的实现是通过回调来实现的，我们来先定义一个 pubsub 对象，其内部包含了 3 个方法：订阅、退订、发布。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">var pubsub = &#123;&#125;;</div><div class="line">(function (q) &#123;</div><div class="line">    var topics = &#123;&#125;, // 回调函数存放的数组</div><div class="line">        subUid = -1;</div><div class="line">    // 发布方法</div><div class="line">    q.publish = function (topic, args) &#123;</div><div class="line">        if (!topics[topic]) &#123;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">        setTimeout(function () &#123;</div><div class="line">            var subscribers = topics[topic],</div><div class="line">                len = subscribers ? subscribers.length : 0;</div><div class="line">            while (len--) &#123;</div><div class="line">                subscribers[len].func(topic, args);</div><div class="line">            &#125;</div><div class="line">        &#125;, 0);</div><div class="line">        return true;</div><div class="line">    &#125;;</div><div class="line">    //订阅方法</div><div class="line">    q.subscribe = function (topic, func) &#123;</div><div class="line">        if (!topics[topic]) &#123;</div><div class="line">            topics[topic] = [];</div><div class="line">        &#125;</div><div class="line">        var token = (++subUid).toString();</div><div class="line">        topics[topic].push(&#123;</div><div class="line">            token: token,</div><div class="line">            func: func</div><div class="line">        &#125;);</div><div class="line">        return token;</div><div class="line">    &#125;;</div><div class="line">    //退订方法</div><div class="line">    q.unsubscribe = function (token) &#123;</div><div class="line">        for (var m in topics) &#123;</div><div class="line">            if (topics[m]) &#123;</div><div class="line">                for (var i = 0, j = topics[m].length; i &lt; j; i++) &#123;</div><div class="line">                    if (topics[m][i].token === token) &#123;</div><div class="line">                        topics[m].splice(i, 1);</div><div class="line">                        return token;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;;</div><div class="line">&#125; (pubsub));</div></pre></td></tr></table></figure>
<p>使用方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//来，订阅一个</div><div class="line">pubsub.subscribe(&apos;example1&apos;, function (topics, data) &#123;</div><div class="line">    console.log(topics + &quot;: &quot; + data);</div><div class="line">&#125;);</div><div class="line">//发布通知</div><div class="line">pubsub.publish(&apos;example1&apos;, &apos;hello world!&apos;);</div><div class="line">pubsub.publish(&apos;example1&apos;, [&apos;test&apos;, &apos;a&apos;, &apos;b&apos;, &apos;c&apos;]);</div><div class="line">pubsub.publish(&apos;example1&apos;, [&#123; &apos;color&apos;: &apos;blue&apos; &#125;, &#123; &apos;text&apos;: &apos;hello&apos;&#125;]);</div></pre></td></tr></table></figure>
<p>怎么样？用起来是不是很爽？但是这种方式有个问题，就是没办法退订订阅，要退订的话必须指定退订的名称，所以我们再来一个版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//将订阅赋值给一个变量，以便退订</div><div class="line">var testSubscription = pubsub.subscribe(&apos;example1&apos;, function (topics, data) &#123;</div><div class="line">    console.log(topics + &quot;: &quot; + data);</div><div class="line">&#125;);</div><div class="line">//发布通知</div><div class="line">pubsub.publish(&apos;example1&apos;, &apos;hello world!&apos;);</div><div class="line">pubsub.publish(&apos;example1&apos;, [&apos;test&apos;, &apos;a&apos;, &apos;b&apos;, &apos;c&apos;]);</div><div class="line">pubsub.publish(&apos;example1&apos;, [&#123; &apos;color&apos;: &apos;blue&apos; &#125;, &#123; &apos;text&apos;: &apos;hello&apos;&#125;]);</div><div class="line">//退订</div><div class="line">setTimeout(function () &#123;</div><div class="line">    pubsub.unsubscribe(testSubscription);</div><div class="line">&#125;, 0);</div><div class="line">//再发布一次，验证一下是否还能够输出信息</div><div class="line">pubsub.publish(&apos;example1&apos;, &apos;hello again! (this will fail)&apos;);</div></pre></td></tr></table></figure>
<h2 id="版本二"><a href="#版本二" class="headerlink" title="版本二"></a>版本二</h2><p>我们也可以利用原型的特性实现一个观察者模式，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">function Observer() &#123;</div><div class="line">    this.fns = [];</div><div class="line">&#125;</div><div class="line">Observer.prototype = &#123;</div><div class="line">    subscribe: function (fn) &#123;</div><div class="line">        this.fns.push(fn);</div><div class="line">    &#125;,</div><div class="line">    unsubscribe: function (fn) &#123;</div><div class="line">        this.fns = this.fns.filter(</div><div class="line">                        function (el) &#123;</div><div class="line">                            if (el !== fn) &#123;</div><div class="line">                                return el;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    );</div><div class="line">    &#125;,</div><div class="line">    update: function (o, thisObj) &#123;</div><div class="line">        var scope = thisObj || window;</div><div class="line">        this.fns.forEach(</div><div class="line">                        function (el) &#123;</div><div class="line">                            el.call(scope, o);</div><div class="line">                        &#125;</div><div class="line">                    );</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//测试</div><div class="line">var o = new Observer;</div><div class="line">var f1 = function (data) &#123;</div><div class="line">    console.log(&apos;Robbin: &apos; + data + &apos;, 赶紧干活了！&apos;);</div><div class="line">&#125;;</div><div class="line">var f2 = function (data) &#123;</div><div class="line">    console.log(&apos;Randall: &apos; + data + &apos;, 找他加点工资去！&apos;);</div><div class="line">&#125;;</div><div class="line">o.subscribe(f1);</div><div class="line">o.subscribe(f2);</div><div class="line">o.update(&quot;Tom回来了！&quot;)</div><div class="line">//退订f1</div><div class="line">o.unsubscribe(f1);</div><div class="line">//再来验证</div><div class="line">o.update(&quot;Tom回来了！&quot;);</div></pre></td></tr></table></figure>
<p>如果提示找不到 filter 或者 forEach 函数，可能是因为你的浏览器还不够新，暂时不支持新标准的函数，你可以使用如下方式自己定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">if (!Array.prototype.forEach) &#123;</div><div class="line">    Array.prototype.forEach = function (fn, thisObj) &#123;</div><div class="line">        var scope = thisObj || window;</div><div class="line">        for (var i = 0, j = this.length; i &lt; j; ++i) &#123;</div><div class="line">            fn.call(scope, this[i], i, this);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line">if (!Array.prototype.filter) &#123;</div><div class="line">    Array.prototype.filter = function (fn, thisObj) &#123;</div><div class="line">        var scope = thisObj || window;</div><div class="line">        var a = [];</div><div class="line">        for (var i = 0, j = this.length; i &lt; j; ++i) &#123;</div><div class="line">            if (!fn.call(scope, this[i], i, this)) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            a.push(this[i]);</div><div class="line">        &#125;</div><div class="line">        return a;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="版本三"><a href="#版本三" class="headerlink" title="版本三"></a>版本三</h2><p>如果想让多个对象都具有观察者发布订阅的功能，我们可以定义一个通用的函数，然后将该函数的功能应用到需要观察者功能的对象上，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">//通用代码</div><div class="line">var observer = &#123;</div><div class="line">    //订阅</div><div class="line">    addSubscriber: function (callback) &#123;</div><div class="line">        this.subscribers[this.subscribers.length] = callback;</div><div class="line">    &#125;,</div><div class="line">    //退订</div><div class="line">    removeSubscriber: function (callback) &#123;</div><div class="line">        for (var i = 0; i &lt; this.subscribers.length; i++) &#123;</div><div class="line">            if (this.subscribers[i] === callback) &#123;</div><div class="line">                delete (this.subscribers[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    //发布</div><div class="line">    publish: function (what) &#123;</div><div class="line">        for (var i = 0; i &lt; this.subscribers.length; i++) &#123;</div><div class="line">            if (typeof this.subscribers[i] === &apos;function&apos;) &#123;</div><div class="line">                this.subscribers[i](what);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    // 将对象o具有观察者功能</div><div class="line">    make: function (o) &#123; </div><div class="line">        for (var i in this) &#123;</div><div class="line">            o[i] = this[i];</div><div class="line">            o.subscribers = [];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>然后订阅 2 个对象 blogger 和 user，使用 observer.make 方法将这 2 个对象具有观察者功能，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var blogger = &#123;</div><div class="line">    recommend: function (id) &#123;</div><div class="line">        var msg = &apos;dudu 推荐了的帖子:&apos; + id;</div><div class="line">        this.publish(msg);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">var user = &#123;</div><div class="line">    vote: function (id) &#123;</div><div class="line">        var msg = &apos;有人投票了!ID=&apos; + id;</div><div class="line">        this.publish(msg);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">observer.make(blogger);</div><div class="line">observer.make(user);</div></pre></td></tr></table></figure>
<p>使用方法就比较简单了，订阅不同的回调函数，以便可以注册到不同的观察者对象里（也可以同时注册到多个观察者对象里）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">var tom = &#123;</div><div class="line">    read: function (what) &#123;</div><div class="line">        console.log(&apos;Tom看到了如下信息：&apos; + what)</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">var mm = &#123;</div><div class="line">    show: function (what) &#123;</div><div class="line">        console.log(&apos;mm看到了如下信息：&apos; + what)</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">// 订阅</div><div class="line">blogger.addSubscriber(tom.read);</div><div class="line">blogger.addSubscriber(mm.show);</div><div class="line">blogger.recommend(123); //调用发布\</div><div class="line">//退订</div><div class="line">blogger.removeSubscriber(mm.show);</div><div class="line">blogger.recommend(456); //调用发布</div><div class="line">//另外一个对象的订阅</div><div class="line">user.addSubscriber(mm.show);</div><div class="line">user.vote(789); //调用发布</div></pre></td></tr></table></figure>
<h2 id="jQuery-版本"><a href="#jQuery-版本" class="headerlink" title="jQuery 版本"></a>jQuery 版本</h2><p>根据 jQuery1.7 版新增的 on/off 功能，我们也可以定义 jQuery 版的观察者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(function ($) &#123;</div><div class="line">    var o = $(&#123;&#125;);</div><div class="line">    $.subscribe = function () &#123;</div><div class="line">        o.on.apply(o, arguments);</div><div class="line">    &#125;;</div><div class="line">    $.unsubscribe = function () &#123;</div><div class="line">        o.off.apply(o, arguments);</div><div class="line">    &#125;;</div><div class="line">    $.publish = function () &#123;</div><div class="line">        o.trigger.apply(o, arguments);</div><div class="line">    &#125;;</div><div class="line">&#125; (jQuery));</div></pre></td></tr></table></figure>
<p>调用方法比上面 3 个版本都简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//回调函数</div><div class="line">function handle(e, a, b, c) &#123;</div><div class="line">    // `e`是事件对象，不需要关注</div><div class="line">    console.log(a + b + c);</div><div class="line">&#125;;</div><div class="line">//订阅</div><div class="line">$.subscribe(&quot;/some/topic&quot;, handle);</div><div class="line">//发布</div><div class="line">$.publish(&quot;/some/topic&quot;, [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]); // 输出abc      </div><div class="line">$.unsubscribe(&quot;/some/topic&quot;, handle); // 退订</div><div class="line">//订阅</div><div class="line">$.subscribe(&quot;/some/topic&quot;, function (e, a, b, c) &#123;</div><div class="line">    console.log(a + b + c);</div><div class="line">&#125;);</div><div class="line">$.publish(&quot;/some/topic&quot;, [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]); // 输出abc</div><div class="line">//退订（退订使用的是/some/topic名称，而不是回调函数哦，和版本一的例子不一样</div><div class="line">$.unsubscribe(&quot;/some/topic&quot;);</div></pre></td></tr></table></figure>
<p>可以看到，他的订阅和退订使用的是字符串名称，而不是回调函数名称，所以即便传入的是匿名函数，我们也是可以退订的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>观察者的使用场合就是：当一个对象的改变需要同时改变其它对象，并且它不知道具体有多少对象需要改变的时候，就应该考虑使用观察者模式。</p>
<p>总的来说，观察者模式所做的工作就是在解耦，让耦合的双方都依赖于抽象，而不是依赖于具体。从而使得各自的变化都不会影响到另一边的变化。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/02/24/JavaScript/深入理解javascript/34设计模式之命令模式/" class="prev">PREV</a><a href="/2014/12/07/JavaScript/深入理解javascript/39设计模式之适配器模式/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://github.com/xuhongbo" target="_blank">xuhongbo-github</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>